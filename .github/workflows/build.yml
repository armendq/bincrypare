name: build

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # every 15 minutes
    - cron: "*/15 * * * *"

permissions:
  contents: write

concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run analyses
        run: |
          set -e
          python -m scripts.analyses

      - name: Prepare public_runs/latest
        run: |
          set -e
          mkdir -p public_runs/latest
          [ -f summary.json ] && cp -f summary.json public_runs/latest/ || true
          [ -f public_runs/latest/summary.json ] || (echo "summary.json missing" && exit 1)

      - name: Verify outputs exist
        run: |
          test -f public_runs/latest/summary.json

      - name: Clean old public_runs folders (keep latest)
        run: |
          find public_runs -maxdepth 1 -mindepth 1 -type d ! -name latest -exec rm -rf {} +

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public_runs
          keep_files: true
          commit_message: "ci: publish public_runs (latest)"

      - name: Verify Pages endpoint
        continue-on-error: true
        shell: bash
        run: |
          set -e
          url="https://armendq.github.io/revolut_crypto_mapping/latest/summary.json?ts=$(date +%s)"
          echo "Checking $url"
          for i in {1..4}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            echo "HTTP $code"
            [ "$code" = "200" ] && exit 0
            sleep 5
          done
          echo "Pages may still be propagating; not failing the build."